package com.mmsapre.platform.service;

import com.fasterxml.jackson.databind.JsonNode;
import com.mmsapre.platform.sql.SqlNames;
import org.postgresql.PGConnection;
import org.postgresql.copy.CopyManager;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;

import java.io.StringReader;
import java.sql.Connection;

@Service
public class BulkService {

    public int bulkCopy(
            JdbcTemplate jdbc,
            String physicalTable,
            JsonNode schema,
            JsonNode payload
    ) throws Exception {

        String csv = payload.get("csv").asText();
        boolean header = payload.path("header").asBoolean(true);

        String copySql = """
            COPY %s FROM STDIN WITH (FORMAT csv, HEADER %s)
        """.formatted(physicalTable, header);

        try (Connection c = jdbc.getDataSource().getConnection()) {
            PGConnection pg = c.unwrap(PGConnection.class);
            CopyManager cm = pg.getCopyAPI();
            return (int) cm.copyIn(copySql, new StringReader(csv));
        }
    }
}
