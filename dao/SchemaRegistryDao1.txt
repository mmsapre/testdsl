package com.mmsapre.platform.registry;

import com.fasterxml.jackson.databind.JsonNode;
import com.mmsapre.platform.util.JsonUtil;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Map;

@Repository
public class SchemaRegistryDao {

    public void ensure(JdbcTemplate jdbc) {
        jdbc.execute("""
            CREATE TABLE IF NOT EXISTS schema_registry (
                table_name     VARCHAR(100),
                version        INT,
                status         VARCHAR(20),
                schema_json    TEXT,
                created_at     TIMESTAMP DEFAULT now(),
                PRIMARY KEY (table_name, version)
            )
        """);
    }

    public int nextVersion(JdbcTemplate jdbc, String table) {
        Integer v = jdbc.queryForObject(
                "SELECT COALESCE(MAX(version),0) FROM schema_registry WHERE table_name=?",
                Integer.class,
                table
        );
        return v + 1;
    }

    public void saveDraft(
            JdbcTemplate jdbc,
            String table,
            int version,
            JsonNode schema
    ) {
        jdbc.update("""
            INSERT INTO schema_registry(table_name,version,status,schema_json)
            VALUES (?,?, 'DRAFT', ?)
        """, table, version, schema.toString());
    }

    public Map<String, Object> latestDraft(JdbcTemplate jdbc, String table) {
        List<Map<String, Object>> rows = jdbc.queryForList("""
            SELECT * FROM schema_registry
            WHERE table_name=? AND status='DRAFT'
            ORDER BY version DESC LIMIT 1
        """, table);
        return rows.isEmpty() ? null : rows.get(0);
    }

    public void activate(JdbcTemplate jdbc, String table, int version) {
        jdbc.update("""
            UPDATE schema_registry
            SET status='INACTIVE'
            WHERE table_name=? AND status='ACTIVE'
        """, table);

        jdbc.update("""
            UPDATE schema_registry
            SET status='ACTIVE'
            WHERE table_name=? AND version=?
        """, table, version);
    }

    public Map<String, Object> active(JdbcTemplate jdbc, String table) {
        return jdbc.queryForMap("""
            SELECT * FROM schema_registry
            WHERE table_name=? AND status='ACTIVE'
        """, table);
    }
}
